# Release Notes v2.8.1

**Release Date:** 2026-02-09
**Type:** Hotfix
**Previous:** v2.8.0

## Overview

ìƒˆê°€ì¡± ë“±ë¡ í˜ì´ì§€(/about/new-family-registration) ë°°í¬ í›„ ë°œê²¬ëœ 3ê°œ ì´ìŠˆ ê¸´ê¸‰ ìˆ˜ì •.

---

## ğŸ”´ Hotfix Details

### 1. ìƒˆê°€ì¡± ë“±ë¡ í…Œì´ë¸” ì°¸ì¡° ìˆ˜ì •

**ë¬¸ì œ**: ë“±ë¡ í¼ì´ ì¡´ì¬í•˜ì§€ ì•ŠëŠ” `new_families` í…Œì´ë¸”ì„ ì°¸ì¡°í•˜ì—¬ HTTP 404 ë°œìƒ.
**í•´ê²°**: `new_family_registrations` í…Œì´ë¸”ë¡œ ë³€ê²½ + í•„ë“œ ë§¤í•‘ ìˆ˜ì •.

- `src/pages/about/new-family-registration.tsx` ìˆ˜ì •
- address â†’ address1, notes â†’ introduction, baptized â†’ baptism_date ë§¤í•‘

### 2. ì„ íƒ í•„ë“œ NOT NULL ì œì•½ í•´ì œ

**ë¬¸ì œ**: `english_name`, `birth_date` ë“± ì„ íƒ ì…ë ¥ í•„ë“œì— NOT NULL ì œì•½ì´ ìˆì–´ ë¹ˆ ê°’ ì „ì†¡ ì‹œ HTTP 400 ë°œìƒ.
**í•´ê²°**:
- **ì½”ë“œ**: `|| null` â†’ `|| ''` (ë¹ˆ ë¬¸ìì—´) + conditional spread íŒ¨í„´
- **DB**: 11ê°œ ì„ íƒ í•„ë“œì˜ NOT NULL ì œì•½ ì¼ê´„ ì œê±°

**ì˜í–¥ í•„ë“œ**: english_name, email, birth_date, gender, previous_church, baptism_date, introduction, family_info, admin_notes, country, address2

### 3. ê³µê°œ í¼ INSERT ê¶Œí•œ ì„¤ì •

**ë¬¸ì œ**: RLS ì •ì±…ë§Œìœ¼ë¡œëŠ” ë¹„ì¸ì¦ ì‚¬ìš©ì(anon role)ì˜ INSERTê°€ ì°¨ë‹¨ë¨. HTTP 401 ë°œìƒ.
**ê·¼ë³¸ ì›ì¸**: Supabaseì—ì„œ ê³µê°œ í¼ì´ ë°ì´í„°ë¥¼ ì‚½ì…í•˜ë ¤ë©´ RLS ì •ì±… + í…Œì´ë¸” GRANT ê¶Œí•œì´ ëª¨ë‘ í•„ìš”.
**í•´ê²°**:
```sql
-- RLS ì •ì±…
CREATE POLICY "new_family_registrations_insert_public" ON new_family_registrations
  FOR INSERT WITH CHECK (true);

-- í…Œì´ë¸” ê¶Œí•œ
GRANT USAGE ON SCHEMA public TO anon;
GRANT INSERT ON new_family_registrations TO anon;
GRANT SELECT ON new_family_registrations TO anon;
```

---

## ğŸ”§ Technical Changes

### Files Modified (1)
| File | Changes |
|------|---------|
| `src/pages/about/new-family-registration.tsx` | í…Œì´ë¸”ëª… ìˆ˜ì • + NOT NULL ì•ˆì „ ì²˜ë¦¬ |

### Database Changes (SQL Editor ì‹¤í–‰ í•„ìš”)
1. `new_family_registrations` 11ê°œ ì»¬ëŸ¼ NOT NULL ì œê±°
2. `new_family_registrations` ê³µê°œ INSERT RLS ì •ì±… ìƒì„±
3. `anon` ì—­í• ì— INSERT/SELECT ê¶Œí•œ ë¶€ì—¬

### New Documentation
| File | Description |
|------|-------------|
| `docs/troubleshooting/new-family-registration-deployment.md` | ì—ëŸ¬ ì§„ë‹¨ ë° í•´ê²° ì ˆì°¨ ê°€ì´ë“œ |

---

## ğŸ“Š Build Statistics

| Metric | Value |
|--------|-------|
| Files Modified | 1 |
| Build Errors | 0 |
| DB SQL Statements | 3 blocks |

---

## ğŸŒ Deployment

- **Platform:** Vercel (ìë™ ë°°í¬)
- **Production URL:** https://www.sckc.org
- **Status:** Deployed
- **Commit:** 76cf0e2

---

## ğŸ”„ Migration Notes

### í•„ìˆ˜: Supabase SQL ì‹¤í–‰
Supabase Dashboard â†’ SQL Editorì—ì„œ ì•„ë˜ SQL ì‹¤í–‰:

```sql
-- 1. NOT NULL ì œê±°
DO $$
DECLARE col TEXT;
BEGIN
  FOREACH col IN ARRAY ARRAY['english_name','email','birth_date','gender','previous_church','baptism_date','introduction','family_info','admin_notes','country','address2']
  LOOP
    IF EXISTS (SELECT 1 FROM information_schema.columns WHERE table_name = 'new_family_registrations' AND column_name = col) THEN
      EXECUTE format('ALTER TABLE new_family_registrations ALTER COLUMN %I DROP NOT NULL', col);
    END IF;
  END LOOP;
END $$;

-- 2. RLS ì •ì±…
DROP POLICY IF EXISTS "new_family_registrations_insert_public" ON new_family_registrations;
CREATE POLICY "new_family_registrations_insert_public" ON new_family_registrations
  FOR INSERT WITH CHECK (true);

-- 3. ê¶Œí•œ
GRANT USAGE ON SCHEMA public TO anon;
GRANT INSERT ON new_family_registrations TO anon;
GRANT SELECT ON new_family_registrations TO anon;
```

### í™•ì¸ ì²´í¬ë¦¬ìŠ¤íŠ¸
- [x] NOT NULL ì œê±° SQL ì‹¤í–‰
- [x] RLS INSERT ì •ì±… ìƒì„±
- [x] GRANT ê¶Œí•œ ë¶€ì—¬
- [x] anon key INSERT í…ŒìŠ¤íŠ¸ ì„±ê³µ (HTTP 201)
- [x] í”„ë¡œë•ì…˜ ì‚¬ì´íŠ¸ ë“±ë¡ í¼ ì •ìƒ ì‘ë™

---

## ğŸ“ êµí›ˆ (Lessons Learned)

1. **RLS + GRANT**: Supabase ê³µê°œ í¼ì€ RLS ì •ì±…ë§Œìœ¼ë¡œëŠ” ë¶€ì¡±, `anon` ì—­í• ì— GRANT í•„ìˆ˜
2. **TypeScript vs DB ìŠ¤í‚¤ë§ˆ**: `types/supabase.ts`ì—ì„œ optional(?)ì¸ í•„ë“œê°€ ì‹¤ì œ DBì—ì„œ NOT NULLì¼ ìˆ˜ ìˆìŒ
3. **PL/pgSQL EXECUTE**: IF EXISTS ë¸”ë¡ ì•ˆì—ì„œ DDL ì‹¤í–‰ ì‹œ ë°˜ë“œì‹œ EXECUTE ì‚¬ìš©
4. **ì—ëŸ¬ ì½”ë“œ í•´ì„**: 404=í…Œì´ë¸” ì—†ìŒ, 400=ì œì•½ ìœ„ë°˜, 401=RLS/ê¶Œí•œ ì°¨ë‹¨
